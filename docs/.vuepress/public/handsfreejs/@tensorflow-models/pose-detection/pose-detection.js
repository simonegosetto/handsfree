/**
    * @license
    * Copyright 2021 Google LLC. All Rights Reserved.
    * Licensed under the Apache License, Version 2.0 (the "License");
    * you may not use this file except in compliance with the License.
    * You may obtain a copy of the License at
    *
    * http://www.apache.org/licenses/LICENSE-2.0
    *
    * Unless required by applicable law or agreed to in writing, software
    * distributed under the License is distributed on an "AS IS" BASIS,
    * WITHOUT WARRANTIES OR CONDITIONS OF ANY KIND, either express or implied.
    * See the License for the specific language governing permissions and
    * limitations under the License.
    * =============================================================================
    */
 !function(e,t){"object"==typeof exports&&"undefined"!=typeof module?t(exports,require("@mediapipe/pose"),require("@tensorflow/tfjs-converter"),require("@tensorflow/tfjs-core")):"function"==typeof define&&define.amd?define(["exports","@mediapipe/pose","@tensorflow/tfjs-converter","@tensorflow/tfjs-core"],t):t((e=e||self).poseDetection={},e.Pose,e.tf,e.tf)}(this,(function(e,t,i,n){"use strict";var r=function(){return(r=Object.assign||function(e){for(var t,i=1,n=arguments.length;i<n;i++)for(var r in t=arguments[i])Object.prototype.hasOwnProperty.call(t,r)&&(e[r]=t[r]);return e}).apply(this,arguments)};function o(e,t,i,n){return new(i||(i=Promise))((function(r,o){function s(e){try{l(n.next(e))}catch(e){o(e)}}function a(e){try{l(n.throw(e))}catch(e){o(e)}}function l(e){var t;e.done?r(e.value):(t=e.value,t instanceof i?t:new i((function(e){e(t)}))).then(s,a)}l((n=n.apply(e,t||[])).next())}))}function s(e,t){var i,n,r,o,s={label:0,sent:function(){if(1&r[0])throw r[1];return r[1]},trys:[],ops:[]};return o={next:a(0),throw:a(1),return:a(2)},"function"==typeof Symbol&&(o[Symbol.iterator]=function(){return this}),o;function a(o){return function(a){return function(o){if(i)throw new TypeError("Generator is already executing.");for(;s;)try{if(i=1,n&&(r=2&o[0]?n.return:o[0]?n.throw||((r=n.return)&&r.call(n),0):n.next)&&!(r=r.call(n,o[1])).done)return r;switch(n=0,r&&(o=[2&o[0],r.value]),o[0]){case 0:case 1:r=o;break;case 4:return s.label++,{value:o[1],done:!1};case 5:s.label++,n=o[1],o=[0];continue;case 7:o=s.ops.pop(),s.trys.pop();continue;default:if(!(r=s.trys,(r=r.length>0&&r[r.length-1])||6!==o[0]&&2!==o[0])){s=0;continue}if(3===o[0]&&(!r||o[1]>r[0]&&o[1]<r[3])){s.label=o[1];break}if(6===o[0]&&s.label<r[1]){s.label=r[1],r=o;break}if(r&&s.label<r[2]){s.label=r[2],s.ops.push(o);break}r[2]&&s.ops.pop(),s.trys.pop();continue}o=t.call(e,s)}catch(e){o=[6,e],n=0}finally{i=r=0}if(5&o[0])throw o[1];return{value:o[0]?o[1]:void 0,done:!0}}([o,a])}}}var a=["nose","left_eye","right_eye","left_ear","right_ear","left_shoulder","right_shoulder","left_elbow","right_elbow","left_wrist","right_wrist","left_hip","right_hip","left_knee","right_knee","left_ankle","right_ankle"],l=["nose","left_eye_inner","left_eye","left_eye_outer","right_eye_inner","right_eye","right_eye_outer","left_ear","right_ear","mouth_left","mouth_right","left_shoulder","right_shoulder","left_elbow","right_elbow","left_wrist","right_wrist","left_pinky","right_pinky","left_index","right_index","left_thumb","right_thumb","left_hip","right_hip","left_knee","right_knee","left_ankle","right_ankle","left_heel","right_heel","left_foot_index","right_foot_index"],u={left:[1,2,3,7,9,11,13,15,17,19,21,23,25,27,29,31],right:[4,5,6,8,10,12,14,16,18,20,22,24,26,28,30,32],middle:[0]},h={left:[1,3,5,7,9,11,13,15],right:[2,4,6,8,10,12,14,16],middle:[0]},c=[[0,1],[0,2],[1,3],[2,4],[5,6],[5,7],[5,11],[6,8],[6,12],[7,9],[8,10],[11,12],[11,13],[12,14],[13,15],[14,16]],p=[[0,1],[0,4],[1,2],[2,3],[3,7],[4,5],[5,6],[6,8],[9,10],[11,12],[11,13],[11,23],[12,14],[14,16],[12,24],[13,15],[15,17],[16,18],[16,20],[15,17],[15,19],[15,21],[16,22],[17,19],[18,20],[23,25],[23,24],[24,26],[25,27],[26,28],[27,29],[28,30],[27,31],[28,32],[29,31],[30,32]],d={runtime:"mediapipe",enableSmoothing:!0,modelType:"full"};var f=function(){function e(e){var i,n=this;switch(this.width=0,this.height=0,this.selfieMode=!1,this.poseSolution=new t.Pose({locateFile:function(t,i){return e.solutionPath?e.solutionPath.replace(/\/+$/,"")+"/"+t:i+"/"+t}}),e.modelType){case"lite":i=0;break;case"heavy":i=2;break;case"full":default:i=1}this.poseSolution.setOptions({modelComplexity:i,smoothLandmarks:e.enableSmoothing||!0,selfieMode:this.selfieMode}),this.poseSolution.onResults((function(e){n.height=e.image.height,n.width=e.image.width,n.poses=n.translateOutputs(e)}))}return e.prototype.translateOutputs=function(e){var t=this;return null!=e.poseLandmarks?[{keypoints:e.poseLandmarks.map((function(e,i){return{x:e.x*t.width,y:e.y*t.height,z:e.z,score:e.visibility,name:l[i]}}))}]:[]},e.prototype.estimatePoses=function(e,t,i){return o(this,void 0,void 0,(function(){return s(this,(function(n){switch(n.label){case 0:return t&&t.flipHorizontal&&t.flipHorizontal!==this.selfieMode&&(this.selfieMode=t.flipHorizontal,this.poseSolution.setOptions({selfieMode:this.selfieMode})),[4,this.poseSolution.send({image:e},i)];case 1:return n.sent(),[2,this.poses]}}))}))},e.prototype.dispose=function(){this.poseSolution.close()},e.prototype.reset=function(){this.poseSolution.reset()},e.prototype.initialize=function(){return this.poseSolution.initialize()},e}();function m(e){return o(this,void 0,void 0,(function(){var t,i;return s(this,(function(n){switch(n.label){case 0:return t=function(e){if(null==e)return r({},d);var t=r({},e);return t.runtime="mediapipe",null==t.enableSmoothing&&(t.enableSmoothing=d.enableSmoothing),null==t.modelType&&(t.modelType=d.modelType),t}(e),[4,(i=new f(t)).initialize()];case 1:return n.sent(),[2,i]}}))}))}function g(e){return e instanceof n.Tensor?{height:e.shape[0],width:e.shape[1]}:{height:e.height,width:e.width}}function y(e){return e-2*Math.PI*Math.floor((e+Math.PI)/(2*Math.PI))}function v(e){return e instanceof n.Tensor?e:n.browser.fromPixels(e)}function x(e,t){n.util.assert(0!==e.width,(function(){return t+" width cannot be 0."})),n.util.assert(0!==e.height,(function(){return t+" height cannot be 0."}))}function w(e,t,i){var r=t.inputResolution,o=t.keepAspectRatio,s=g(e),a=function(e,t){return t?{xCenter:t.xCenter*e.width,yCenter:t.yCenter*e.height,width:t.width*e.width,height:t.height*e.height,rotation:t.rotation}:{xCenter:.5*e.width,yCenter:.5*e.height,width:e.width,height:e.height,rotation:0}}(s,i),l=function(e,t,i){if(void 0===i&&(i=!1),!i)return{top:0,left:0,right:0,bottom:0};var n=t.height,r=t.width;x(t,"targetSize"),x(e,"roi");var o,s,a=n/r,l=e.height/e.width,u=0,h=0;return a>l?(o=e.width,s=e.width*a,h=(1-l/a)/2):(o=e.height/a,s=e.height,u=(1-a/l)/2),e.width=o,e.height=s,{top:h,left:u,right:u,bottom:h}}(a,r,o);return{imageTensor:n.tidy((function(){var t=v(e),i=n.tensor2d(function(e,t,i,n){x(n,"inputResolution");var r=1/t.width,o=1/t.height,s=e.xCenter,a=e.yCenter,l=Math.cos(e.rotation),u=Math.sin(e.rotation),h=i?-1:1,c=e.width,p=e.height;return[1/n.width*c*l*h*r*t.width,1/n.height*-p*u*r*t.width,(-.5*c*l*h+.5*p*u+s)*r*t.width,1/n.width*c*u*h*o*t.height,1/n.height*p*l*o*t.height,(-.5*p*l-.5*c*u*h+a)*o*t.height,0,0]}(a,s,!1,r),[1,8]);return n.image.transform(n.expandDims(n.cast(t,"float32")),i,"bilinear","nearest",0,[r.height,r.width])})),padding:l}}function b(e){return null!=e&&null!=e.currentTime}var M=function(){function e(e){this.alpha=e,this.initialized=!1}return e.prototype.apply=function(e,t){var i;return this.initialized?i=null==t?this.storedValue+this.alpha*(e-this.storedValue):this.storedValue+this.alpha*t*Math.asinh((e-this.storedValue)/t):(i=e,this.initialized=!0),this.rawValue=e,this.storedValue=i,i},e.prototype.applyWithAlpha=function(e,t,i){return this.alpha=t,this.apply(e,i)},e.prototype.hasLastRawValue=function(){return this.initialized},e.prototype.lastRawValue=function(){return this.rawValue},e.prototype.reset=function(){this.initialized=!1},e}(),S=function(){function e(e){this.frequency=e.frequency,this.minCutOff=e.minCutOff,this.beta=e.beta,this.thresholdCutOff=e.thresholdCutOff,this.thresholdBeta=e.thresholdBeta,this.derivateCutOff=e.derivateCutOff,this.x=new M(this.getAlpha(this.minCutOff)),this.dx=new M(this.getAlpha(this.derivateCutOff)),this.lastTimestamp=0}return e.prototype.apply=function(e,t,i){if(null==e)return e;var n=Math.trunc(t);if(this.lastTimestamp>=n)return e;0!==this.lastTimestamp&&0!==n&&(this.frequency=1/(1e-6*(n-this.lastTimestamp))),this.lastTimestamp=n;var r=this.x.hasLastRawValue()?(e-this.x.lastRawValue())*i*this.frequency:0,o=this.dx.applyWithAlpha(r,this.getAlpha(this.derivateCutOff)),s=this.minCutOff+this.beta*Math.abs(o),a=null!=this.thresholdCutOff?this.thresholdCutOff+this.thresholdBeta*Math.abs(o):null;return this.x.applyWithAlpha(e,this.getAlpha(s),a)},e.prototype.getAlpha=function(e){return 1/(1+this.frequency/(2*Math.PI*e))},e}(),_=function(){function e(e){this.config=e}return e.prototype.apply=function(e,t,i){var n=this;if(null==e)return this.reset(),null;this.initializeFiltersIfEmpty(e);var o=1;if(null!=this.config.minAllowedObjectScale){if(i<this.config.minAllowedObjectScale)return e.slice();o=1/i}return e.map((function(e,i){var s=r({},e,{x:n.xFilters[i].apply(e.x,t,o),y:n.yFilters[i].apply(e.y,t,o)});return null!=e.z&&(s.z=n.zFilters[i].apply(e.z,t,o)),s}))},e.prototype.reset=function(){this.xFilters=null,this.yFilters=null,this.zFilters=null},e.prototype.initializeFiltersIfEmpty=function(e){var t=this;null!=this.xFilters&&this.xFilters.length===e.length||(this.xFilters=e.map((function(e){return new S(t.config)})),this.yFilters=e.map((function(e){return new S(t.config)})),this.zFilters=e.map((function(e){return new S(t.config)})))},e}();function k(e,t){return e.map((function(e){var i=r({},e,{x:e.x/t.width,y:e.y/t.height});return null!=e.z&&(e.z=e.z/t.width),i}))}var R=function(){function e(e){this.config=e,this.window=[],this.lowPassFilter=new M(1),this.lastValue=0,this.lastValueScale=1,this.lastTimestamp=-1}return e.prototype.apply=function(e,t,i){if(null==e)return e;var n,r=Math.trunc(t);if(this.lastTimestamp>=r)return e;if(-1===this.lastTimestamp)n=1;else{for(var o=e*i-this.lastValue*this.lastValueScale,s=r-this.lastTimestamp,a=o,l=s,u=(1+this.window.length)*(1e6/30),h=0,c=this.window;h<c.length;h++){var p=c[h];if(l+p.duration>u)break;a+=p.distance,l+=p.duration}var d=a/(1e-6*l);n=1-1/(1+this.config.velocityScale*Math.abs(d)),this.window.unshift({distance:o,duration:s}),this.window.length>this.config.windowSize&&this.window.pop()}return this.lastValue=e,this.lastValueScale=i,this.lastTimestamp=r,this.lowPassFilter.applyWithAlpha(e,n)},e}(),z=function(){function e(e){this.config=e}return e.prototype.apply=function(e,t,i){var n=this;if(null==e)return this.reset(),null;var o=1;if(!this.config.disableValueScaling){if(i<this.config.minAllowedObjectScale)return e.slice();o=1/i}return this.initializeFiltersIfEmpty(e),e.map((function(e,i){var s=r({},e,{x:n.xFilters[i].apply(e.x,t,o),y:n.yFilters[i].apply(e.y,t,o)});return null!=e.z&&(s.z=n.zFilters[i].apply(e.z,t,o)),s}))},e.prototype.reset=function(){this.xFilters=null,this.yFilters=null,this.zFilters=null},e.prototype.initializeFiltersIfEmpty=function(e){var t=this;null!=this.xFilters&&this.xFilters.length===e.length||(this.xFilters=e.map((function(e){return new R(t.config)})),this.yFilters=e.map((function(e){return new R(t.config)})),this.zFilters=e.map((function(e){return new R(t.config)})))},e}();function F(e,t){return e.map((function(e){var i=r({},e,{x:e.x*t.width,y:e.y*t.height});return null!=e.z&&(i.z=e.z*t.width),i}))}var T=function(){function e(e){if(null!=e.velocityFilter)this.keypointsFilter=new z(e.velocityFilter);else{if(null==e.oneEuroFilter)throw new Error("Either configure velocityFilter or oneEuroFilter, but got "+e+".");this.keypointsFilter=new _(e.oneEuroFilter)}}return e.prototype.apply=function(e,t,i,n,r){if(void 0===n&&(n=!1),null==e)return this.keypointsFilter.reset(),null;var o=null!=r?function(e,t){return(e.width*t.width+e.height*t.height)/2}(r,i):1,s=n?F(e,i):e,a=this.keypointsFilter.apply(s,t,o);return n?k(a,i):a},e}();function O(e,t){var i=function(e,t,i,n){var r=t-e,o=n-i;if(0===r)throw new Error("Original min and max are both "+e+", range cannot be 0.");var s=o/r;return{scale:s,offset:i-e*s}}(0,255,t[0],t[1]);return n.tidy((function(){return n.add(n.mul(e,i.scale),i.offset)}))}function P(e,t,i){var n=i.rotationVectorStartKeypointIndex,r=i.rotationVectorEndKeypointIndex,o=e.locationData,s=o.relativeKeypoints[n].x*t.width,a=o.relativeKeypoints[n].y*t.height,l=o.relativeKeypoints[r].x*t.width,u=o.relativeKeypoints[r].y*t.height,h=2*Math.sqrt((l-s)*(l-s)+(u-a)*(u-a)),c=function(e,t,i){var n,r=e.locationData,o=i.rotationVectorStartKeypointIndex,s=i.rotationVectorEndKeypointIndex;n=i.rotationVectorTargetAngle?i.rotationVectorTargetAngle:Math.PI*i.rotationVectorTargetAngleDegree/180;var a=r.relativeKeypoints[o].x*t.width,l=r.relativeKeypoints[o].y*t.height,u=r.relativeKeypoints[s].x*t.width,h=r.relativeKeypoints[s].y*t.height;return y(n-Math.atan2(-(h-l),u-a))}(e,t,i);return{xCenter:s/t.width,yCenter:a/t.height,width:h/t.width,height:h/t.height,rotation:c}}function C(e,t,i,n){return 1===n?.5*(e+t):e+(t-e)*i/(n-1)}function I(e,t){return n.tidy((function(){var i=function(e){return n.tidy((function(){var t=n.slice(e,[0,0,0],[1,-1,1]);return[n.sigmoid(t),n.slice(e,[0,0,1],[1,-1,-1])]}))}(t.predict(e)),r=i[0],o=i[1];return{boxes:n.squeeze(o),scores:n.squeeze(r)}}))}function E(e){for(var t={locationData:{relativeKeypoints:[]}},i=Number.MAX_SAFE_INTEGER,n=Number.MIN_SAFE_INTEGER,r=Number.MAX_SAFE_INTEGER,o=Number.MIN_SAFE_INTEGER,s=0;s<e.length;++s){var a=e[s];i=Math.min(i,a.x),n=Math.max(n,a.x),r=Math.min(r,a.y),o=Math.max(o,a.y),t.locationData.relativeKeypoints.push({x:a.x,y:a.y})}return t.locationData.relativeBoundingBox={xMin:i,yMin:r,xMax:n,yMax:o,width:n-i,height:o-r},t}function A(e,t,i,r){return o(this,void 0,void 0,(function(){var o,a,l,u,h;return s(this,(function(s){switch(s.label){case 0:return o=n.tensor2d(e.map((function(e){return[e.locationData.relativeBoundingBox.yMin,e.locationData.relativeBoundingBox.xMin,e.locationData.relativeBoundingBox.yMax,e.locationData.relativeBoundingBox.xMax]}))),a=n.tensor1d(e.map((function(e){return e.score[0]}))),[4,n.image.nonMaxSuppressionAsync(o,a,t,i,r)];case 1:return[4,(l=s.sent()).array()];case 2:return u=s.sent(),h=e.filter((function(e,t){return u.indexOf(t)>-1})),n.dispose([o,a,l]),[2,h]}}))}))}function B(e,t,i){return o(this,void 0,void 0,(function(){var o,a,l,u,h,c,p,d,f,m,g,y,v,x,w,b,M,S,_,k,R,z,F,T;return s(this,(function(s){switch(s.label){case 0:if(o=n.squeeze(t,[0]),a=o.shape,l=a[0],u=a[1],h=a[2],e.length!==h)throw new Error("Expected heatmap to have same number of channels as the number of landmarks. But got landmarks length: "+e.length+", heatmap length: "+h);return c=[],[4,o.buffer()];case 1:for(p=s.sent(),d=0;d<e.length;d++)if(f=e[d],m=r({},f),c.push(m),g=Math.trunc(m.x*u),y=Math.trunc(m.y*l),!(g<0||g>=u||y<0||g>=l)){for(v=Math.trunc((i.kernelSize-1)/2),x=Math.max(0,g-v),w=Math.min(u,g+v+1),b=Math.max(0,y-v),M=Math.min(l,y+v+1),S=0,_=0,k=0,R=0,z=b;z<M;++z)for(F=x;F<w;++F)T=p.get(z,F,d),S+=T,R=Math.max(R,T),_+=F*T,k+=z*T;R>=i.minConfidenceToRefine&&S>0&&(m.x=_/u/S,m.y=k/l/S)}return o.dispose(),[2,c]}}))}))}function N(e,t,i){return o(this,void 0,void 0,(function(){var r,o,a,l,u;return s(this,(function(s){switch(s.label){case 0:return r=e[0],o=e[1],a=function(e,t,i){return n.tidy((function(){var r,o,s,a;i.reverseOutputOrder?(o=n.squeeze(n.slice(e,[0,i.boxCoordOffset+0],[-1,1])),r=n.squeeze(n.slice(e,[0,i.boxCoordOffset+1],[-1,1])),a=n.squeeze(n.slice(e,[0,i.boxCoordOffset+2],[-1,1])),s=n.squeeze(n.slice(e,[0,i.boxCoordOffset+3],[-1,1]))):(r=n.squeeze(n.slice(e,[0,i.boxCoordOffset+0],[-1,1])),o=n.squeeze(n.slice(e,[0,i.boxCoordOffset+1],[-1,1])),s=n.squeeze(n.slice(e,[0,i.boxCoordOffset+2],[-1,1])),a=n.squeeze(n.slice(e,[0,i.boxCoordOffset+3],[-1,1]))),o=n.add(n.mul(n.div(o,i.xScale),t.w),t.x),r=n.add(n.mul(n.div(r,i.yScale),t.h),t.y),i.applyExponentialOnBoxSize?(s=n.mul(n.exp(n.div(s,i.hScale)),t.h),a=n.mul(n.exp(n.div(a,i.wScale)),t.w)):(s=n.mul(n.div(s,i.hScale),t.h),a=n.mul(n.div(a,i.wScale),t.h));var l=n.sub(r,n.div(s,2)),u=n.sub(o,n.div(a,2)),h=n.add(r,n.div(s,2)),c=n.add(o,n.div(a,2)),p=n.concat([n.reshape(l,[i.numBoxes,1]),n.reshape(u,[i.numBoxes,1]),n.reshape(h,[i.numBoxes,1]),n.reshape(c,[i.numBoxes,1])],1);if(i.numKeypoints)for(var d=0;d<i.numKeypoints;++d){var f=i.keypointCoordOffset+d*i.numValuesPerKeypoint,m=void 0,g=void 0;i.reverseOutputOrder?(m=n.squeeze(n.slice(e,[0,f],[-1,1])),g=n.squeeze(n.slice(e,[0,f+1],[-1,1]))):(g=n.squeeze(n.slice(e,[0,f],[-1,1])),m=n.squeeze(n.slice(e,[0,f+1],[-1,1])));var y=n.add(n.mul(n.div(m,i.xScale),t.w),t.x),v=n.add(n.mul(n.div(g,i.yScale),t.h),t.y);p=n.concat([p,n.reshape(y,[i.numBoxes,1]),n.reshape(v,[i.numBoxes,1])],1)}return p}))}(o,t,i),l=n.tidy((function(){var e=r;return i.sigmoidScore?(null!=i.scoreClippingThresh&&(e=n.clipByValue(r,-i.scoreClippingThresh,i.scoreClippingThresh)),e=n.sigmoid(e)):e})),[4,V(a,l,i)];case 1:return u=s.sent(),n.dispose([a,l]),[2,u]}}))}))}function V(e,t,i){return o(this,void 0,void 0,(function(){var n,r,o,a,l,u,h,c,p,d,f,m;return s(this,(function(s){switch(s.label){case 0:return n=[],[4,e.data()];case 1:return r=s.sent(),[4,t.data()];case 2:for(o=s.sent(),a=0;a<i.numBoxes;++a)if(!(null!=i.minScoreThresh&&o[a]<i.minScoreThresh||(l=a*i.numCoords,u=q(r[l+0],r[l+1],r[l+2],r[l+3],o[a],i.flipVertically,a),(h=u.locationData.relativeBoundingBox).width<0||h.height<0))){if(i.numKeypoints>0)for((c=u.locationData).relativeKeypoints=[],p=i.numKeypoints*i.numValuesPerKeypoint,d=0;d<p;d+=i.numValuesPerKeypoint)f=l+i.keypointCoordOffset+d,m={x:r[f+0],y:i.flipVertically?1-r[f+1]:r[f+1]},c.relativeKeypoints.push(m);n.push(u)}return[2,n]}}))}))}function q(e,t,i,n,r,o,s){return{score:[r],ind:s,locationData:{relativeBoundingBox:{xMin:t,yMin:o?1-i:e,xMax:n,yMax:o?1-e:i,width:n-t,height:i-e}}}}function K(e,t,i,n){return void 0===i&&(i=!1),void 0===n&&(n=!1),o(this,void 0,void 0,(function(){var r,o,a,l,u,h,c,p;return s(this,(function(s){switch(s.label){case 0:return r=e.size,o=r/t.numLandmarks,[4,e.data()];case 1:for(a=s.sent(),l=[],u=0;u<t.numLandmarks;++u)h=u*o,(p={x:0,y:0}).x=i?t.inputImageWidth-a[h]:a[h],o>1&&(p.y=n?t.inputImageHeight-a[h+1]:a[h+1]),o>2&&(p.z=a[h+2]),o>3&&(p.score=(d=a[h+3],1/(1+Math.exp(-d)))),l.push(p);for(c=0;c<l.length;++c)(p=l[c]).x=p.x/t.inputImageWidth,p.y=p.y/t.inputImageHeight,p.z=p.z/t.inputImageWidth/(t.normalizeZ||1);return[2,l]}var d}))}))}function L(e,t,i){var n=e.width,r=e.height,o=e.rotation;if(null==i.rotation&&null==i.rotationDegree||(o=function(e,t){null!=t.rotation?e+=t.rotation:null!=t.rotationDegree&&(e+=Math.PI*t.rotationDegree/180);return y(e)}(o,i)),0===o)e.xCenter=e.xCenter+n*i.shiftX,e.yCenter=e.yCenter+r*i.shiftY;else{var s=(t.width*n*i.shiftX*Math.cos(o)-t.height*r*i.shiftY*Math.sin(o))/t.width,a=(t.width*n*i.shiftX*Math.sin(o)+t.height*r*i.shiftY*Math.cos(o))/t.height;e.xCenter=e.xCenter+s,e.yCenter=e.yCenter+a}if(i.squareLong){var l=Math.max(n*t.width,r*t.height);n=l/t.width,r=l/t.height}else if(i.squareShort){var u=Math.min(n*t.width,r*t.height);n=u/t.width,r=u/t.height}return e.width=n*i.scaleX,e.height=r*i.scaleY,e}var D=function(){function e(e){this.alpha=e.alpha}return e.prototype.apply=function(e){var t=this;if(null==e)return this.visibilityFilters=null,null;null!=this.visibilityFilters&&this.visibilityFilters.length===e.length||(this.visibilityFilters=e.map((function(e){return new M(t.alpha)})));for(var i=[],n=0;n<e.length;++n){var o=e[n],s=r({},o);s.score=this.visibilityFilters[n].apply(o.score),i.push(s)}return i},e}(),j={reduceBoxesInLowestlayer:!1,interpolatedScaleAspectRatio:1,featureMapHeight:[],featureMapWidth:[],numLayers:5,minScale:.1484375,maxScale:.75,inputSizeHeight:224,inputSizeWidth:224,anchorOffsetX:.5,anchorOffsetY:.5,strides:[8,16,32,32,32],aspectRatios:[1],fixedAnchorSize:!0},X={runtime:"tfjs",modelType:"full",enableSmoothing:!0,detectorModelUrl:"https://tfhub.dev/mediapipe/tfjs-model/blazeposedetector/1/default/1",landmarkModelUrl:"https://tfhub.dev/mediapipe/tfjs-model/blazeposelandmark_full/1/default/1"},H={maxPoses:1,flipHorizontal:!1},Y={applyExponentialOnBoxSize:!1,flipVertically:!1,ignoreClasses:[],numClasses:1,numBoxes:2254,numCoords:12,boxCoordOffset:0,keypointCoordOffset:4,numKeypoints:4,numValuesPerKeypoint:2,sigmoidScore:!0,scoreClippingThresh:100,reverseOutputOrder:!0,xScale:224,yScale:224,hScale:224,wScale:224,minScoreThresh:.5},U=-1,G=.3,W={shiftX:0,shiftY:0,scaleX:1.25,scaleY:1.25,squareLong:!0},Q={inputResolution:{width:224,height:224},keepAspectRatio:!0},Z={inputResolution:{width:256,height:256},keepAspectRatio:!0},$={numLandmarks:39,inputImageWidth:256,inputImageHeight:256},J={kernelSize:7,minConfidenceToRefine:.5},ee={alpha:.1},te={oneEuroFilter:{frequency:30,minCutOff:.05,beta:80,derivateCutOff:1,minAllowedObjectScale:1e-6}},ie={oneEuroFilter:{frequency:30,minCutOff:.01,beta:10,derivateCutOff:1,minAllowedObjectScale:1e-6}};var ne,re=function(){function e(e,t,i,r){this.detectorModel=e,this.landmarkModel=t,this.enableSmoothing=i,this.modelType=r,this.regionOfInterest=null,this.anchors=function(e){for(var t=[],i=0;i<e.numLayers;){for(var n=[],r=[],o=[],s=[],a=i;a<e.strides.length&&e.strides[a]===e.strides[i];){var l=C(e.minScale,e.maxScale,a,e.strides.length);if(0===a&&e.reduceBoxesInLowestLayer)o.push(1),o.push(2),o.push(.5),s.push(.1),s.push(l),s.push(l);else{for(var u=0;u<e.aspectRatios.length;++u)o.push(e.aspectRatios[u]),s.push(l);if(e.interpolatedScaleAspectRatio>0){var h=a===e.strides.length-1?1:C(e.minScale,e.maxScale,a+1,e.strides.length);s.push(Math.sqrt(l*h)),o.push(e.interpolatedScaleAspectRatio)}}a++}for(var c=0;c<o.length;++c){var p=Math.sqrt(o[c]);n.push(s[c]/p),r.push(s[c]*p)}var d=0,f=0;if(e.featureMapHeight.length>0)d=e.featureMapHeight[i],f=e.featureMapWidth[i];else{var m=e.strides[i];d=Math.ceil(e.inputSizeHeight/m),f=Math.ceil(e.inputSizeWidth/m)}for(var g=0;g<d;++g)for(var y=0;y<f;++y)for(var v=0;v<n.length;++v){var x={xCenter:(y+e.anchorOffsetX)/f,yCenter:(g+e.anchorOffsetY)/d,width:0,height:0};e.fixedAnchorSize?(x.width=1,x.height=1):(x.width=r[v],x.height=n[v]),t.push(x)}i=a}return t}(j);var o=n.tensor1d(this.anchors.map((function(e){return e.width}))),s=n.tensor1d(this.anchors.map((function(e){return e.height}))),a=n.tensor1d(this.anchors.map((function(e){return e.xCenter}))),l=n.tensor1d(this.anchors.map((function(e){return e.yCenter})));this.anchorTensor={x:a,y:l,w:o,h:s}}return e.prototype.estimatePoses=function(e,t,i){return o(this,void 0,void 0,(function(){var o,a,u,h,c,p,d,f,m,y,x,w,M,S,_;return s(this,(function(s){switch(s.label){case 0:return o=function(e){var t;if(null==(t=null==e?H:r({},e)).maxPoses&&(t.maxPoses=1),t.maxPoses<=0)throw new Error("Invalid maxPoses "+t.maxPoses+". Should be > 0.");if(t.maxPoses>1)throw new Error("Multi-pose detection is not implemented yet. Please set maxPoses to 1.");return t}(t),null==e?(this.reset(),[2,[]]):(this.maxPoses=o.maxPoses,this.timestamp=null!=i?1e3*i:b(e)?1e6*e.currentTime:null,a=g(e),u=n.tidy((function(){return n.cast(v(e),"float32")})),null!=(h=this.regionOfInterest)?[3,2]:[4,this.detectPose(u)]);case 1:if(0===(c=s.sent()).length)return this.reset(),u.dispose(),[2,[]];p=c[0],h=this.poseDetectionToRoi(p,a),s.label=2;case 2:return[4,this.poseLandmarksByRoi(h,u)];case 3:return d=s.sent(),u.dispose(),null==d?(this.reset(),[2,[]]):(f=d.actualLandmarks,m=d.auxiliaryLandmarks,y=d.poseScore,x=this.poseLandmarkFiltering(f,m,a),w=x.actualLandmarksFiltered,M=x.auxiliaryLandmarksFiltered,S=this.poseLandmarksToRoi(M,a),this.regionOfInterest=S,null!=(_=null!=w?F(w,a):null)&&_.forEach((function(e,t){e.name=l[t]})),[2,[{score:y,keypoints:_}]])}}))}))},e.prototype.dispose=function(){this.detectorModel.dispose(),this.landmarkModel.dispose(),n.dispose([this.anchorTensor.x,this.anchorTensor.y,this.anchorTensor.w,this.anchorTensor.h])},e.prototype.reset=function(){this.regionOfInterest=null,this.visibilitySmoothingFilterActual=null,this.visibilitySmoothingFilterAuxiliary=null,this.landmarksSmoothingFilterActual=null,this.landmarksSmoothingFilterAuxiliary=null},e.prototype.detectPose=function(e){return o(this,void 0,void 0,(function(){var t,i,r,o,a,l,u,h,c;return s(this,(function(s){switch(s.label){case 0:return t=w(e,Q),i=t.imageTensor,r=t.padding,o=O(i,[-1,1]),a=I(o,this.detectorModel),l=a.boxes,[4,N([u=a.scores,l],this.anchorTensor,Y)];case 1:return[4,A(s.sent(),this.maxPoses,G,U)];case 2:return h=s.sent(),c=function(e,t){void 0===e&&(e=[]);for(var i=t.left,n=t.top,r=t.left+t.right,o=t.top+t.bottom,s=0;s<e.length;s++){var a=e[s],l=a.locationData.relativeBoundingBox,u=(l.xMin-i)/(1-r),h=(l.yMin-n)/(1-o),c=l.width/(1-r),p=l.height/(1-o);l.xMin=u,l.yMin=h,l.width=c,l.height=p;for(var d=0;d<a.locationData.relativeKeypoints.length;++d){var f=a.locationData.relativeKeypoints[d],m=(f.x-i)/(1-r),g=(f.y-n)/(1-o);f.x=m,f.y=g}}return e}(h,r),n.dispose([i,o,u,l]),[2,c]}}))}))},e.prototype.poseDetectionToRoi=function(e,t){return 0,1,L(P(e,t,{rotationVectorEndKeypointIndex:1,rotationVectorStartKeypointIndex:0,rotationVectorTargetAngleDegree:90}),t,W)},e.prototype.poseLandmarksByRoi=function(e,t){return o(this,void 0,void 0,(function(){var i,o,a,l,u,h,c,p,d,f,m,g,y,v;return s(this,(function(s){switch(s.label){case 0:switch(i=w(t,Z,e),o=i.imageTensor,a=i.padding,l=O(o,[0,1]),u=this.landmarkModel.predict(l),this.modelType){case"lite":h=u[2],c=u[4],p=u[3];break;case"full":h=u[4],c=u[3],p=u[1];break;case"heavy":h=u[3],c=u[1],p=u[4];break;default:throw new Error("Model type must be one of lite, full or heavy,but got "+this.modelType)}return[4,c.data()];case 1:return(d=s.sent()[0])<.5?(n.dispose(u),n.dispose([o,l]),[2,null]):[4,K(h,$)];case 2:return[4,B(s.sent(),p,J)];case 3:return f=s.sent(),m=function(e,t){var i=t.left,n=t.top,o=t.left+t.right,s=t.top+t.bottom;return e.map((function(e){return r({},e,{x:(e.x-i)/(1-o),y:(e.y-n)/(1-s),z:e.z/(1-o)})}))}(f,a),g=function(e,t,i){void 0===i&&(i={ignoreRotation:!1});for(var n=[],o=0,s=e;o<s.length;o++){var a=s[o],l=a.x-.5,u=a.y-.5,h=i.ignoreRotation?0:t.rotation,c=Math.cos(h)*l-Math.sin(h)*u,p=Math.sin(h)*l+Math.cos(h)*u;c=c*t.width+t.xCenter,p=p*t.height+t.yCenter;var d=a.z*t.width,f=r({},a);f.x=c,f.y=p,f.z=d,n.push(f)}return n}(m,e),y=g.slice(0,33),v=g.slice(33,35),n.dispose(u),n.dispose([o,l]),[2,{actualLandmarks:y,auxiliaryLandmarks:v,poseScore:d}]}}))}))},e.prototype.poseLandmarksToRoi=function(e,t){return L(P(E(e),t,{rotationVectorStartKeypointIndex:0,rotationVectorEndKeypointIndex:1,rotationVectorTargetAngleDegree:90}),t,W)},e.prototype.poseLandmarkFiltering=function(e,t,i){var n,r;if(null!=this.timestamp&&this.enableSmoothing){var o=P(E(t),i,{rotationVectorEndKeypointIndex:0,rotationVectorStartKeypointIndex:1,rotationVectorTargetAngleDegree:90});null==this.visibilitySmoothingFilterActual&&(this.visibilitySmoothingFilterActual=new D(ee)),n=this.visibilitySmoothingFilterActual.apply(e),null==this.visibilitySmoothingFilterAuxiliary&&(this.visibilitySmoothingFilterAuxiliary=new D(ee)),r=this.visibilitySmoothingFilterAuxiliary.apply(t),null==this.landmarksSmoothingFilterActual&&(this.landmarksSmoothingFilterActual=new T(te)),n=this.landmarksSmoothingFilterActual.apply(n,this.timestamp,i,!0,o),null==this.landmarksSmoothingFilterAuxiliary&&(this.landmarksSmoothingFilterAuxiliary=new T(ie)),r=this.landmarksSmoothingFilterAuxiliary.apply(r,this.timestamp,i,!0,o)}else n=e,r=t;return{actualLandmarksFiltered:n,auxiliaryLandmarksFiltered:r}},e}();function oe(e){return o(this,void 0,void 0,(function(){var t,n,o,a,l,u;return s(this,(function(s){switch(s.label){case 0:return t=function(e){var t=r({},null==e?X:e);if(null==t.enableSmoothing&&(t.enableSmoothing=X.enableSmoothing),null==t.modelType&&(t.modelType=X.modelType),null==t.detectorModelUrl&&(t.detectorModelUrl=X.detectorModelUrl),null==t.landmarkModelUrl)switch(t.modelType){case"lite":t.landmarkModelUrl="https://tfhub.dev/mediapipe/tfjs-model/blazeposelandmark_lite/1/default/1";break;case"heavy":t.landmarkModelUrl="https://tfhub.dev/mediapipe/tfjs-model/blazeposelandmark_heavy/1/default/1";break;case"full":default:t.landmarkModelUrl="https://tfhub.dev/mediapipe/tfjs-model/blazeposelandmark_full/1/default/1"}return t}(e),n=t.detectorModelUrl.indexOf("https://tfhub.dev")>-1,o=t.landmarkModelUrl.indexOf("https://tfhub.dev")>-1,[4,Promise.all([i.loadGraphModel(t.detectorModelUrl,{fromTFHub:n}),i.loadGraphModel(t.landmarkModelUrl,{fromTFHub:o})])];case 1:return a=s.sent(),l=a[0],u=a[1],[2,new re(l,u,t.enableSmoothing,t.modelType)]}}))}))}function se(t){switch(t){case e.SupportedModels.BlazePose:return l.reduce((function(e,t,i){return e[t]=i,e}),{});case e.SupportedModels.PoseNet:case e.SupportedModels.MoveNet:return a.reduce((function(e,t,i){return e[t]=i,e}),{});default:throw new Error("Model "+t+" is not supported.")}}(ne=e.SupportedModels||(e.SupportedModels={})).MoveNet="MoveNet",ne.BlazePose="BlazePose",ne.PoseNet="PoseNet";var ae=Object.freeze({__proto__:null,getKeypointIndexBySide:function(t){switch(t){case e.SupportedModels.BlazePose:return u;case e.SupportedModels.PoseNet:case e.SupportedModels.MoveNet:return h;default:throw new Error("Model "+t+" is not supported.")}},getAdjacentPairs:function(t){switch(t){case e.SupportedModels.BlazePose:return p;case e.SupportedModels.PoseNet:case e.SupportedModels.MoveNet:return c;default:throw new Error("Model "+t+" is not supported.")}},getKeypointIndexByName:se}),le=["SinglePose.Lightning","SinglePose.Thunder"],ue={modelType:"SinglePose.Lightning",enableSmoothing:!0},he={maxPoses:1},ce={frequency:30,minCutOff:6.36,beta:636.61,derivateCutOff:4.77,thresholdCutOff:.5,thresholdBeta:5};var pe=function(){function t(t,i){this.moveNetModel=t,this.modelInputResolution={height:0,width:0},this.keypointIndexByName=se(e.SupportedModels.MoveNet),this.keypointsFilter=new _(ce),this.cropRegionFilterYMin=new M(.9),this.cropRegionFilterXMin=new M(.9),this.cropRegionFilterYMax=new M(.9),this.cropRegionFilterXMax=new M(.9),"SinglePose.Lightning"===i.modelType?(this.modelInputResolution.width=192,this.modelInputResolution.height=192):"SinglePose.Thunder"===i.modelType&&(this.modelInputResolution.width=256,this.modelInputResolution.height=256),this.enableSmoothing=i.enableSmoothing}return t.prototype.detectKeypoints=function(e,t){return void 0===t&&(t=!0),o(this,void 0,void 0,(function(){var i,r,o,a,l;return s(this,(function(s){switch(s.label){case 0:return this.moveNetModel?(i=17,t?(r=this.moveNetModel.execute(e),[3,3]):[3,1]):[2,null];case 1:return[4,this.moveNetModel.executeAsync(e)];case 2:r=s.sent(),s.label=3;case 3:return r&&4===r.shape.length&&1===r.shape[0]&&1===r.shape[1]&&r.shape[2]===i&&3===r.shape[3]?"webgpu"===n.getBackend()?[3,4]:(o=r.dataSync(),[3,6]):(r.dispose(),[2,null]);case 4:return[4,r.data()];case 5:o=s.sent(),s.label=6;case 6:for(r.dispose(),a=[],l=0;l<i;++l)a[l]={y:o[3*l],x:o[3*l+1],score:o[3*l+2]};return[2,a]}}))}))},t.prototype.estimatePoses=function(e,t,i){return void 0===t&&(t=he),o(this,void 0,void 0,(function(){var o,l,u,h,c,p,d,f,m,y=this;return s(this,(function(s){switch(s.label){case 0:return t=function(e){var t=null==e?he:r({},e);if(t.maxPoses||(t.maxPoses=1),t.maxPoses<=0||t.maxPoses>1)throw new Error("Invalid maxPoses "+t.maxPoses+". Should be 1.");return t}(t),null==e?(this.reset(),[2,[]]):(null==i?b(e)&&(i=1e6*e.currentTime):i*=1e3,o=v(e),l=g(o),u=n.expandDims(o,0),e instanceof n.Tensor||o.dispose(),this.cropRegion||(this.cropRegion=this.initCropRegion(l.width,l.height)),h=n.tidy((function(){var e=n.tensor2d([[y.cropRegion.yMin,y.cropRegion.xMin,y.cropRegion.yMax,y.cropRegion.xMax]]),t=n.zeros([1],"int32"),i=[y.modelInputResolution.height,y.modelInputResolution.width];return n.cast(n.image.cropAndResize(u,e,t,i,"bilinear",0),"int32")})),u.dispose(),[4,this.detectKeypoints(h)]);case 1:if(c=s.sent(),h.dispose(),null==c)return this.reset(),[2,[]];for(m=0;m<c.length;++m)c[m].y=this.cropRegion.yMin+c[m].y*this.cropRegion.height,c[m].x=this.cropRegion.xMin+c[m].x*this.cropRegion.width;for(null!=i&&this.enableSmoothing&&(c=this.keypointsFilter.apply(c,i,1)),p=this.determineCropRegion(c,l.height,l.width),this.cropRegion=this.filterCropRegion(p),d=0,f=0,m=0;m<c.length;++m)c[m].name=a[m],c[m].y*=l.height,c[m].x*=l.width,c[m].score>.2&&(++d,f+=c[m].score);return d>0?f/=d:this.resetFilters(),[2,[{score:f,keypoints:c}]]}}))}))},t.prototype.filterCropRegion=function(e){if(e){var t=this.cropRegionFilterYMin.apply(e.yMin),i=this.cropRegionFilterXMin.apply(e.xMin),n=this.cropRegionFilterYMax.apply(e.yMax),r=this.cropRegionFilterXMax.apply(e.xMax);return{yMin:t,xMin:i,yMax:n,xMax:r,height:n-t,width:r-i}}return this.cropRegionFilterYMin.reset(),this.cropRegionFilterXMin.reset(),this.cropRegionFilterYMax.reset(),this.cropRegionFilterXMax.reset(),null},t.prototype.dispose=function(){this.moveNetModel.dispose()},t.prototype.reset=function(){this.cropRegion=null,this.resetFilters()},t.prototype.resetFilters=function(){this.keypointsFilter.reset(),this.cropRegionFilterYMin.reset(),this.cropRegionFilterXMin.reset(),this.cropRegionFilterYMax.reset(),this.cropRegionFilterXMax.reset()},t.prototype.torsoVisible=function(e){return(e[this.keypointIndexByName.left_hip].score>.2||e[this.keypointIndexByName.right_hip].score>.2)&&(e[this.keypointIndexByName.left_shoulder].score>.2||e[this.keypointIndexByName.right_shoulder].score>.2)},t.prototype.determineTorsoAndBodyRange=function(e,t,i,n){for(var r=["left_shoulder","right_shoulder","left_hip","right_hip"],o=0,s=0,a=0;a<r.length;a++){(p=Math.abs(i-t[r[a]][0]))>o&&(o=p),(d=Math.abs(n-t[r[a]][1]))>s&&(s=d)}for(var l=0,u=0,h=0,c=Object.keys(t);h<c.length;h++){var p,d,f=c[h];if(!(e[this.keypointIndexByName[f]].score<.2))(p=Math.abs(i-t[f][0]))>l&&(l=p),(d=Math.abs(n-t[f][1]))>u&&(u=d)}return[o,s,l,u]},t.prototype.determineCropRegion=function(e,t,i){for(var n={},r=0,o=a;r<o.length;r++){var s=o[r];n[s]=[e[this.keypointIndexByName[s]].y*t,e[this.keypointIndexByName[s]].x*i]}if(this.torsoVisible(e)){var l=(n.left_hip[0]+n.right_hip[0])/2,u=(n.left_hip[1]+n.right_hip[1])/2,h=this.determineTorsoAndBodyRange(e,n,l,u),c=h[0],p=h[1],d=h[2],f=h[3],m=Math.max(1.9*p,1.9*c,1.2*d,1.2*f),g=[l-(m=Math.min(m,Math.max(u,i-u,l,t-l))),u-m];if(m>Math.max(i,t)/2)return this.initCropRegion(t,i);var y=2*m;return{yMin:g[0]/t,xMin:g[1]/i,yMax:(g[0]+y)/t,xMax:(g[1]+y)/i,height:(g[0]+y)/t-g[0]/t,width:(g[1]+y)/i-g[1]/i}}return this.initCropRegion(t,i)},t.prototype.initCropRegion=function(e,t){var i,n,r,o;return this.cropRegion?t>e?(i=t/e,n=1,r=(e/2-t/2)/e,o=0):(i=1,n=e/t,r=0,o=(t/2-e/2)/t):t>e?(i=1,n=e/t,r=0,o=(t/2-e/2)/t):(i=t/e,n=1,r=(e/2-t/2)/e,o=0),{yMin:r,xMin:o,yMax:r+i,xMax:o+n,height:i,width:n}},t}();function de(e){return void 0===e&&(e=ue),o(this,void 0,void 0,(function(){var t,n,o;return s(this,(function(s){switch(s.label){case 0:return(t=function(e){var t=null==e?ue:r({},e);if(e.modelType){if(le.indexOf(t.modelType)<0)throw new Error("Invalid architecture "+t.modelType+". Should be one of "+le)}else e.modelType="SinglePose.Lightning";return null==t.enableSmoothing&&(t.enableSmoothing=!0),t}(e)).modelUrl?[4,i.loadGraphModel(t.modelUrl)]:[3,2];case 1:return n=s.sent(),[3,4];case 2:return o=void 0,"SinglePose.Lightning"===t.modelType?o="https://tfhub.dev/google/tfjs-model/movenet/singlepose/lightning/3":"SinglePose.Thunder"===t.modelType&&(o="https://tfhub.dev/google/tfjs-model/movenet/singlepose/thunder/3"),[4,i.loadGraphModel(o,{fromTFHub:!0})];case 3:n=s.sent(),s.label=4;case 4:return[2,new pe(n,t)]}}))}))}var fe={architecture:"MobileNetV1",outputStride:16,multiplier:.75,inputResolution:{height:257,width:257}},me=["MobileNetV1","ResNet50"],ge={MobileNetV1:[8,16],ResNet50:[16]},ye=[8,16,32],ve={MobileNetV1:[.5,.75,1],ResNet50:[1]},xe=[1,2,4],we={maxPoses:1,flipHorizontal:!1},be={maxPoses:5,flipHorizontal:!1,scoreThreshold:.5,nmsRadius:20},Me=[-123.15,-115.9,-103.06];function Se(e){return Math.floor(e/2)}var _e=function(){function e(e,t){this.priorityQueue=new Array(e),this.numberOfElements=-1,this.getElementValue=t}return e.prototype.enqueue=function(e){this.priorityQueue[++this.numberOfElements]=e,this.swim(this.numberOfElements)},e.prototype.dequeue=function(){var e=this.priorityQueue[0];return this.exchange(0,this.numberOfElements--),this.sink(0),this.priorityQueue[this.numberOfElements+1]=null,e},e.prototype.empty=function(){return-1===this.numberOfElements},e.prototype.size=function(){return this.numberOfElements+1},e.prototype.all=function(){return this.priorityQueue.slice(0,this.numberOfElements+1)},e.prototype.max=function(){return this.priorityQueue[0]},e.prototype.swim=function(e){for(;e>0&&this.less(Se(e),e);)this.exchange(e,Se(e)),e=Se(e)},e.prototype.sink=function(e){for(;2*e<=this.numberOfElements;){var t=2*e;if(t<this.numberOfElements&&this.less(t,t+1)&&t++,!this.less(e,t))break;this.exchange(e,t),e=t}},e.prototype.getValueAt=function(e){return this.getElementValue(this.priorityQueue[e])},e.prototype.less=function(e,t){return this.getValueAt(e)<this.getValueAt(t)},e.prototype.exchange=function(e,t){var i=this.priorityQueue[e];this.priorityQueue[e]=this.priorityQueue[t],this.priorityQueue[t]=i},e}();function ke(e,t,i,n,r,o){for(var s=o.shape,a=s[0],l=s[1],u=!0,h=Math.max(i-r,0),c=Math.min(i+r+1,a),p=h;p<c;++p){for(var d=Math.max(n-r,0),f=Math.min(n+r+1,l),m=d;m<f;++m)if(o.get(p,m,e)>t){u=!1;break}if(!u)break}return u}function Re(e){return o(this,void 0,void 0,(function(){return s(this,(function(t){return[2,Promise.all(e.map((function(e){return e.buffer()})))]}))}))}function ze(e,t,i,n){return{y:n.get(e,t,i),x:n.get(e,t,i+17)}}function Fe(e,t,i){var n=ze(e.heatmapY,e.heatmapX,e.id,i),r=n.y,o=n.x;return{x:e.heatmapX*t+o,y:e.heatmapY*t+r}}function Te(e,t,i,n){var r=i.x,o=i.y;return e.some((function(e){var i,s,a,l,u,h,c=e.keypoints;return i=o,s=r,a=c[n].y,l=c[n].x,(u=a-i)*u+(h=l-s)*h<=t}))}var Oe=a.reduce((function(e,t,i){return e[t]=i,e}),{}),Pe=[["nose","left_eye"],["left_eye","left_ear"],["nose","right_eye"],["right_eye","right_ear"],["nose","left_shoulder"],["left_shoulder","left_elbow"],["left_elbow","left_wrist"],["left_shoulder","left_hip"],["left_hip","left_knee"],["left_knee","left_ankle"],["nose","right_shoulder"],["right_shoulder","right_elbow"],["right_elbow","right_wrist"],["right_shoulder","right_hip"],["right_hip","right_knee"],["right_knee","right_ankle"]].map((function(e){var t=e[0],i=e[1];return[Oe[t],Oe[i]]})),Ce=Pe.map((function(e){return e[1]})),Ie=Pe.map((function(e){return e[0]}));function Ee(e,t,i){return e<t?t:e>i?i:e}function Ae(e,t,i,n){return{y:Ee(Math.round(e.y/t),0,i-1),x:Ee(Math.round(e.x/t),0,n-1)}}function Be(e,t){return{x:e.x+t.x,y:e.y+t.y}}function Ne(e,t,i,n,r,o,s,l){void 0===l&&(l=2);for(var u=n.shape,h=u[0],c=u[1],p={y:t.y,x:t.x},d=Be(p,function(e,t,i){var n=i.shape[2]/2;return{y:i.get(t.y,t.x,e),x:i.get(t.y,t.x,n+e)}}(e,Ae(p,o,h,c),s)),f=0;f<l;f++){var m=Ae(d,o,h,c),g=ze(m.y,m.x,i,r);d=Be({x:m.x*o,y:m.y*o},{x:g.x,y:g.y})}var y=Ae(d,o,h,c),v=n.get(y.y,y.x,i);return{y:d.y,x:d.x,name:a[i],score:v}}function Ve(e,t,i,n,r,o){var s=t.shape[2],l=Ce.length,u=new Array(s),h=e.part,c=e.score,p=Fe(h,n,i);u[h.id]={score:c,name:a[h.id],y:p.y,x:p.x};for(var d=l-1;d>=0;--d){var f=Ce[d],m=Ie[d];u[f]&&!u[m]&&(u[m]=Ne(d,u[f],m,t,i,n,o))}for(d=0;d<l;++d){f=Ie[d],m=Ce[d];u[f]&&!u[m]&&(u[m]=Ne(d,u[f],m,t,i,n,r))}return u}function qe(e,t,i){return i.reduce((function(i,n,r){var o=n.y,s=n.x,a=n.score;return Te(e,t,{y:o,x:s},r)||(i+=a),i}),0)/i.length}function Ke(e,t,i,n,r,a,l,u){return void 0===l&&(l=.5),void 0===u&&(u=20),o(this,void 0,void 0,(function(){var o,h,c,p,d,f,m,g,y,v,x,w;return s(this,(function(s){switch(s.label){case 0:return[4,Re([e,t,i,n])];case 1:for(o=s.sent(),h=o[0],c=o[1],p=o[2],d=o[3],f=[],m=function(e,t,i){for(var n=i.shape,r=n[0],o=n[1],s=n[2],a=new _e(r*o*s,(function(e){return e.score})),l=0;l<r;++l)for(var u=0;u<o;++u)for(var h=0;h<s;++h){var c=i.get(l,u,h);c<e||ke(h,c,l,u,t,i)&&a.enqueue({score:c,part:{heatmapY:l,heatmapX:u,id:h}})}return a}(l,1,h),g=u*u;f.length<a&&!m.empty();)y=m.dequeue(),v=Fe(y.part,r,c),Te(f,g,v,y.part.id)||(x=Ve(y,h,c,r,p,d),w=qe(f,g,x),f.push({keypoints:x,score:w}));return[2,f]}}))}))}function Le(e){var t=e.shape,i=t[0],r=t[1],o=t[2];return n.tidy((function(){var t,s,a=n.reshape(e,[i*r,o]),l=n.argMax(a,0),u=n.expandDims(n.div(l,n.scalar(r,"int32")),1),h=n.expandDims((t=l,s=r,n.tidy((function(){var e=n.div(t,n.scalar(s,"int32"));return n.sub(t,n.mul(e,n.scalar(s,"int32")))}))),1);return n.concat([u,h],1)}))}function De(e,t,i){return n.tidy((function(){var r=function(e,t){for(var i=[],r=0;r<a.length;r++){var o=e.get(r,0).valueOf(),s=e.get(r,1).valueOf(),l=je(o,s,r,t),u=l.x,h=l.y;i.push(h),i.push(u)}return n.tensor2d(i,[a.length,2])}(e,i);return n.add(n.cast(n.mul(e.toTensor(),n.scalar(t,"int32")),"float32"),r)}))}function je(e,t,i,n){return{y:n.get(e,t,i),x:n.get(e,t,i+a.length)}}function Xe(e,t,i){return o(this,void 0,void 0,(function(){var n,r,o,l,u,h,c,p,d,f;return s(this,(function(s){switch(s.label){case 0:return n=0,r=Le(e),[4,Promise.all([e.buffer(),t.buffer(),r.buffer()])];case 1:return o=s.sent(),l=o[0],u=o[1],h=o[2],[4,(c=De(h,i,u)).buffer()];case 2:return p=s.sent(),d=Array.from(function(e,t){for(var i=t.shape[0],n=new Float32Array(i),r=0;r<i;r++){var o=t.get(r,0),s=t.get(r,1);n[r]=e.get(o,s,r)}return n}(l,h)),f=d.map((function(e,t){return n+=e,{y:p.get(t,0),x:p.get(t,1),score:e,name:a[t]}})),r.dispose(),c.dispose(),[2,{keypoints:f,score:n/f.length}]}}))}))}function He(e,t){return(e-1)%t==0}var Ye="https://storage.googleapis.com/tfjs-models/savedmodel/posenet/mobilenet/",Ue="https://storage.googleapis.com/tfjs-models/savedmodel/posenet/resnet50/";function Ge(e,t){return function(e,t){return(e-1)%t==0}(e,t)?e:Math.floor(e/t)*t+1}var We=function(){function e(e,t){this.posenetModel=e;var i=this.posenetModel.inputs[0].shape;n.util.assert(-1===i[1]&&-1===i[2],(function(){return"Input shape ["+i[1]+", "+i[2]+"] must both be equal to or -1"}));var r,o,s=(r=t.inputResolution,o=t.outputStride,{height:Ge(r.height,o),width:Ge(r.width,o)});!function(e){n.util.assert(ye.indexOf(e)>=0,(function(){return"outputStride of "+e+" is invalid. It must be either 8 or 16."}))}(t.outputStride),function(e,t){n.util.assert(He(e.height,t),(function(){return"height of "+e.height+" is invalid for output stride "+t+"."})),n.util.assert(He(e.width,t),(function(){return"width of "+e.width+" is invalid for output stride "+t+"."}))}(s,t.outputStride),this.inputResolution=s,this.outputStride=t.outputStride,this.architecture=t.architecture}return e.prototype.estimatePoses=function(e,t){return void 0===t&&(t=we),o(this,void 0,void 0,(function(){var i,o,a,l,u,h,c,p,d,f,m,y,v,x,b;return s(this,(function(s){switch(s.label){case 0:return i=function(e){var t=e;if(null==t.maxPoses&&(t.maxPoses=1),t.maxPoses<=0)throw new Error("Invalid maxPoses "+t.maxPoses+". Should be > 0.");if(t.maxPoses>1){if((t=r({},be,t)).scoreThreshold<0||t.scoreThreshold>1)throw new Error("Invalid scoreThreshold "+t.scoreThreshold+". Should be in range [0.0, 1.0]");if(t.nmsRadius<=0)throw new Error("Invalid nmsRadius "+t.nmsRadius+".")}return t}(t),null==e?[2,[]]:(this.maxPoses=i.maxPoses,o=w(e,{inputResolution:this.inputResolution,keepAspectRatio:!0}),a=o.imageTensor,l=o.padding,u="ResNet50"===this.architecture?n.add(a,Me):O(a,[-1,1]),h=this.posenetModel.predict(u),"ResNet50"===this.architecture?(c=n.squeeze(h[2],[0]),p=n.squeeze(h[3],[0]),d=n.squeeze(h[0],[0]),f=n.squeeze(h[1],[0])):(c=n.squeeze(h[0],[0]),p=n.squeeze(h[1],[0]),d=n.squeeze(h[2],[0]),f=n.squeeze(h[3],[0])),m=n.sigmoid(p),1!==this.maxPoses?[3,2]:[4,Xe(m,c,this.outputStride)]);case 1:return v=s.sent(),y=[v],[3,4];case 2:return[4,Ke(m,c,d,f,this.outputStride,this.maxPoses,i.scoreThreshold,i.nmsRadius)];case 3:y=s.sent(),s.label=4;case 4:return x=g(e),b=function(e,t,i,n){var r=t.height,o=t.width,s=r/(i.height*(1-n.top-n.bottom)),a=o/(i.width*(1-n.left-n.right)),l=-n.top*i.height,u=-n.left*i.width;if(1===a&&1===s&&0===l&&0===u)return e;for(var h=0,c=e;h<c.length;h++)for(var p=0,d=c[h].keypoints;p<d.length;p++){var f=d[p];f.x=(f.x+u)*a,f.y=(f.y+l)*s}return e}(y,x,this.inputResolution,l),i.flipHorizontal&&(b=function(e,t){for(var i=0,n=e;i<n.length;i++)for(var r=0,o=n[i].keypoints;r<o.length;r++){var s=o[r];s.x=t.width-1-s.x}return e}(b,x)),a.dispose(),u.dispose(),n.dispose(h),c.dispose(),p.dispose(),d.dispose(),f.dispose(),m.dispose(),[2,b]}}))}))},e.prototype.dispose=function(){this.posenetModel.dispose()},e.prototype.reset=function(){},e}();function Qe(e){return void 0===e&&(e=fe),o(this,void 0,void 0,(function(){var t,n,r,o,a;return s(this,(function(s){switch(s.label){case 0:return"ResNet50"!==(t=function(e){var t=e||fe;if(null==t.architecture&&(t.architecture="MobileNetV1"),me.indexOf(t.architecture)<0)throw new Error("Invalid architecture "+t.architecture+". Should be one of "+me);if(null==t.inputResolution&&(t.inputResolution={height:257,width:257}),null==t.outputStride&&(t.outputStride=16),ge[t.architecture].indexOf(t.outputStride)<0)throw new Error("Invalid outputStride "+t.outputStride+". Should be one of "+ge[t.architecture]+" for architecture "+t.architecture+".");if(null==t.multiplier&&(t.multiplier=1),ve[t.architecture].indexOf(t.multiplier)<0)throw new Error("Invalid multiplier "+t.multiplier+". Should be one of "+ve[t.architecture]+" for architecture "+t.architecture+".");if(null==t.quantBytes&&(t.quantBytes=4),xe.indexOf(t.quantBytes)<0)throw new Error("Invalid quantBytes "+t.quantBytes+". Should be one of "+xe+" for architecture "+t.architecture+".");if("MobileNetV1"===t.architecture&&32===t.outputStride&&1!==t.multiplier)throw new Error("When using an output stride of 32, you must select 1 as the multiplier.");return t}(e)).architecture?[3,2]:(l=t.outputStride,u=t.quantBytes,h="model-stride"+l+".json",n=4===u?Ue+"float/"+h:Ue+"quant"+u+"/"+h,[4,i.loadGraphModel(t.modelUrl||n)]);case 1:return r=s.sent(),[2,new We(r,t)];case 2:return o=function(e,t,i){var n={1:"100",.75:"075",.5:"050"},r="model-stride"+e+".json";return 4===i?Ye+"float/"+n[t]+"/"+r:Ye+"quant"+i+"/"+n[t]+"/"+r}(t.outputStride,t.multiplier,t.quantBytes),[4,i.loadGraphModel(t.modelUrl||o)];case 3:return a=s.sent(),[2,new We(a,t)]}var l,u,h}))}))}var Ze={keypointsToNormalizedKeypoints:k},$e={modelType:{SINGLEPOSE_LIGHTNING:"SinglePose.Lightning",SINGLEPOSE_THUNDER:"SinglePose.Thunder"}};e.calculators=Ze,e.createDetector=function(t,i){return o(this,void 0,void 0,(function(){var n,r;return s(this,(function(o){switch(t){case e.SupportedModels.PoseNet:return[2,Qe(i)];case e.SupportedModels.BlazePose:if(r=void 0,null!=(n=i)){if("tfjs"===n.runtime)return[2,oe(i)];if("mediapipe"===n.runtime)return[2,m(i)];r=n.runtime}throw new Error("Expect modelConfig.runtime to be either 'tfjs' or 'mediapipe', but got "+r);case e.SupportedModels.MoveNet:return[2,de(i)];default:throw new Error(t+" is not a supported model name.")}}))}))},e.movenet=$e,e.util=ae,Object.defineProperty(e,"__esModule",{value:!0})}));